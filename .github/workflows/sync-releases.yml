name: Sync Releases from Original Repository

on:
  schedule:
    - cron: "0 * * * *"  # 每小时同步一次（UTC 时间）
  workflow_dispatch:  # 允许手动触发

jobs:
  sync-releases:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Fork Repository
        uses: actions/checkout@v3

      - name: Install jq
        run: sudo apt-get install -y jq  # 安装 jq 工具

      - name: Fetch and Create Releases
        run: |
          ORIGINAL_REPO="blinko-space/blinko"  # 替换为原仓库的 owner/repo
          GH_TOKEN=${{ secrets.GH_TOKEN }}

          # 获取原仓库的最近 3 个 Release 信息
          RELEASES=$(curl -s -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/repos/$ORIGINAL_REPO/releases?per_page=3" \
            | jq '.[] | {id: .id, tag_name: .tag_name, name: .name}')

          # 处理每个 Release
          for release in $(echo "$RELEASES" | jq -c '.'); do
            TAG_NAME=$(echo "$release" | jq -r '.tag_name')
            NAME=$(echo "$release" | jq -r '.name')
            BODY="release $NAME, $TAG_NAME"

            # 使用 jq -sR . 处理 body 中的 Markdown 内容
            ESCAPED_BODY=$(echo "$BODY" | jq -sR .)

            # 创建 Release
            curl -X POST -H "Authorization: token $GH_TOKEN" \
              -d "{\"tag_name\":\"$TAG_NAME\",\"name\":\"$NAME\",\"body\":$ESCAPED_BODY,\"draft\":false,\"prerelease\":false}" \
              "https://api.github.com/repos/LiangWei88/blinko/releases"
          done